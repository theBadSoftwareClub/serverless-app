AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  A Serverless Application

Parameters:
  RootDomain:
    Type: String
    Default: "thebadsoftwareclub.net"

  AwsAccountId:
    Type: String
    Default: ""

  AwsDefaultRegion:
    Type: String
    Default: "us-west-2"

  AcmCertificateId:
    Type: String
    Default: ""

  RootHostedZone:
    Type: String
    Default: ""

  AppDomain:
    Type: String
    Default: "exampleapp"

  AuthDomain:
    Type: String
    Default: "exampleauth"

  ApiDomain:
    Type: String
    Default: "exampleapi"

  CfHostedZone:
    Type: String
    Default: "Z2FDTNDATAQYW2"

Resources:
  # The Cognito User Pool, Client, and Domain are for the Authentication Service
  ExampleUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: exampleusers
      AutoVerifiedAttributes:
        - email
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
          RequireUppercase: true
      UsernameAttributes:
        - email
      Schema:
        - AttributeDataType: String
          Name: email
          Required: false

  ExampleUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref ExampleUserPool
      ClientName: ExampleUserPoolClient
      GenerateSecret: false
      AllowedOAuthFlows:
        - implicit
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthScopes:
        - openid
        - email
        - profile
      CallbackURLs:
        - !Sub "https://${AppDomain}.${RootDomain}"
      ExplicitAuthFlows:
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_USER_SRP_AUTH
        - ALLOW_CUSTOM_AUTH
      SupportedIdentityProviders:
        - COGNITO

  ExampleUserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      UserPoolId: !Ref ExampleUserPool
      Domain: !Sub "${AuthDomain}.${RootDomain}"
      CustomDomainConfig:
        CertificateArn: !Sub "arn:aws:acm:us-east-1:${AwsAccountId}:certificate/${AcmCertificateId}"

        #   ... creating the record set for the cognito auth url is still pending an  outstanding issue and requires a
        #  workaround not included in this example: https://github.com/aws-cloudformation/cloudformation-coverage-roadmap/issues/241

  # The Data Bucket is in S3 for Object Storage
  ExampleDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: example-data-store

  # DynamoDB Tables are for key-value data
  ExampleItemsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: exampleitems
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: createdBy
          AttributeType: S
        - AttributeName: itemId
          AttributeType: S
      KeySchema:
        - AttributeName: itemId
          KeyType: HASH
        - AttributeName: createdBy
          KeyType: RANGE

  # The Api and Lambda Functions make up the server-side functionality
  ExampleApi:
    Type: AWS::Serverless::Api
    Properties:
      Domain:
        DomainName: !Sub "${ApiDomain}.${RootDomain}"
        CertificateArn: !Sub "arn:aws:acm:us-east-1:${AwsAccountId}:certificate/${AcmCertificateId}"
        EndpointConfiguration: EDGE
        Route53:
          HostedZoneId: !Ref RootHostedZone
      Auth:
        Authorizers:
          ExampleAuth:
            AuthorizationScopes:
              - email
              - openid
            UserPoolArn: !GetAtt ExampleUserPool.Arn
            Identity:
              Header: Authorization
      StageName: Prod
      DefinitionBody:
        openapi: "3.0.1"
        info:
          title: "ExampleApi"
          version: "1.0"
        servers:
          - url:  !Sub "https://${ApiDomain}.${RootDomain}"
        paths:
          /:
            get:
              parameters:
                - name: "Access-Control-Allow-Origin"
                  in: "header"
                  schema:
                    type: "string"
              responses:
                "404":
                  description: "404 response"
                  content: { }
                "500":
                  description: "500 response"
                  content: { }
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                    Access-Control-Allow-Methods:
                      schema:
                        type: "string"
                    Access-Control-Allow-Credentials:
                      schema:
                        type: "string"
                    Access-Control-Allow-Headers:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - exampleAuth: [ ]
              x-amazon-apigateway-integration:
                responses:
                  "5\\d{2}":
                    statusCode: "500"
                  "2\\d{2}":
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                    responseTemplates:
                      application/json: "{\r\n    \"statusCode\": 200,\r\n    \"message\"\
                                    : \"API Response\"\r\n}"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_templates"
                type: "mock"
            options:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                    Access-Control-Allow-Methods:
                      schema:
                        type: "string"
                    Access-Control-Allow-Credentials:
                      schema:
                        type: "string"
                    Access-Control-Allow-Headers:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"
          /items:
            get:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - ExampleAuth: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AwsDefaultRegion}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AwsDefaultRegion}:${AwsAccountId}:function:ExampleItemsFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            post:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - Example: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AwsDefaultRegion}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AwsDefaultRegion}:${AwsAccountId}:function:ExampleItemsFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                    Access-Control-Allow-Methods:
                      schema:
                        type: "string"
                    Access-Control-Allow-Headers:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS,POST'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                    responseTemplates:
                      application/json: "{}\n"
                requestTemplates:
                  application/json: "{\n  \"statusCode\" : 200\n}\n"
                passthroughBehavior: "when_no_match"
                type: "mock"
          /items/createdBy:
            get:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - ExampleAuth: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AwsDefaultRegion}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AwsDefaultRegion}:${AwsAccountId}:function:ExampleItemsFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                    Access-Control-Allow-Methods:
                      schema:
                        type: "string"
                    Access-Control-Allow-Headers:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"
          /items/{itemId+}:
            get:
              parameters:
                - name: "itemId"
                  in: "path"
                  required: true
                  schema:
                    type: "string"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - exampleAuth: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AwsDefaultRegion}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AwsDefaultRegion}:${AwsAccountId}:function:ExampleItemsFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                cacheNamespace: "15yjo6"
                cacheKeyParameters:
                  - "method.request.path.itemId"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            put:
              parameters:
                - name: "itemId"
                  in: "path"
                  required: true
                  schema:
                    type: "string"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - exampleAuth: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AwsDefaultRegion}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AwsDefaultRegion}:${AwsAccountId}:function:ExampleItemsFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                cacheNamespace: "15yjo6"
                cacheKeyParameters:
                  - "method.request.path.itemId"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            delete:
              parameters:
                - name: "itemId"
                  in: "path"
                  required: true
                  schema:
                    type: "string"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - ExampoleAuth: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AwsDefaultRegion}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AwsDefaultRegion}:${AwsAccountId}:function:ExampleItemsFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                cacheNamespace: "15yjo6"
                cacheKeyParameters:
                  - "method.request.path.itemId"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              parameters:
                - name: "itemId"
                  in: "path"
                  required: true
                  schema:
                    type: "string"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                    Access-Control-Allow-Methods:
                      schema:
                        type: "string"
                    Access-Control-Allow-Headers:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'DELETE,GET,HEAD,OPTIONS,PATCH,POST,PUT'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"

  ExampleItemsFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ExampleItemsFn
      Role: !GetAtt ExampleItemsRole.Arn
      Handler: lambda_function.lambda_handler
      Runtime: python3.7
      CodeUri: functions/items/
      Description: >-
        plans
      MemorySize: 512
      Timeout: 10
      Events:
        ItemsCreatedByEvent:
          Type: Api
          Properties:
            Path: '/items/createdBy'
            Method: get
            RestApiId:
              Ref: ExampleApi
        NewItemEvent:
          Type: Api
          Properties:
            Path: '/items'
            Method: post
            RestApiId:
              Ref: ExampleApi
        GetItemEvent:
          Type: Api
          Properties:
            Path: '/items/{itemId+}'
            Method: get
            RestApiId:
              Ref: ExampleApi
        UpdateItemEvent:
          Type: Api
          Properties:
            Path: '/items/{itemId+}'
            Method: put
            RestApiId:
              Ref: ExampleApi
        DeleteItemEvent:
          Type: Api
          Properties:
            Path: '/items/{itemId+}'
            Method: delete
            RestApiId:
              Ref: ExampleApi

  # ... with a log-group for server-side logs
  ExampleItemsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${ExampleItemsFn}"
      RetentionInDays: 30

  # ... and permissions for the Lambdas
  ExampleItemsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole

  ExampleLogGroupPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "allow-lambda-logging"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - logs:CreateLogStream
              - logs:DescribeLogStreams
              - logs:PutLogEvents
            Resource:
              - "arn:aws:logs:*:822675929081:log-group:/aws/lambda/ExampleItemsFn"
              - "arn:aws:logs:*:822675929081:log-group:/aws/lambda/ExampleItemsFn:log-stream:*"
      Roles:
        - !Ref ExampleItemsRole

  ExampleDynamoDBPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "allow-dynamoDB-access"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:BatchGetItem
              - dynamodb:BatchWriteItem
              - dynamodb:ConditionCheckItem
              - dynamodb:PutItem
              - dynamodb:DeleteItem
              - dynamodb:DescribeContributorInsights
              - dynamodb:Scan
              - dynamodb:ListTagsOfResource
              - dynamodb:Query
              - dynamodb:DescribeStream
              - dynamodb:UpdateItem
              - dynamodb:DescribeTimeToLive
              - dynamodb:PartiQLSelect
              - dynamodb:DescribeTable
              - dynamodb:GetShardIterator
              - dynamodb:GetItem
              - dynamodb:DescribeContinuousBackups
              - dynamodb:DescribeKinesisStreamingDestination
              - dynamodb:GetRecords
              - dynamodb:DescribeTableReplicaAutoScaling
            Resource:
              - "arn:aws:dynamodb:us-west-2:822675929081:table/exampleitems"
              - "arn:aws:dynamodb:*:822675929081:table/exampleitems/stream/*"
      Roles:
        - !Ref ExampleItemsRole

  ExampleS3DataStorePolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "allow-datastore-access"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - s3:PutObject
              - s3:GetObject
              - s3:ListBucket
              - s3:DeleteObject
            Resource:
              - "arn:aws:s3:::example-data-store/*"
              - "arn:aws:s3:::example-data-store"
      Roles:
        - !Ref ExampleItemsRole

  # The Client-side app is hosted with a CloudFront Distribution.
  ExampleAppDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Comment: 'Cloudfront distribution for client App'
        Aliases:
          - !Sub "${AppDomain}.${RootDomain}"
        DefaultCacheBehavior:
          AllowedMethods:
            - HEAD
            - GET
            - OPTIONS
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
          Compress: true
          SmoothStreaming: false
          TargetOriginId: example-client-app
          ViewerProtocolPolicy: redirect-to-https
        DefaultRootObject: index.html
        Enabled: true
        HttpVersion: http2
        Logging:
          Bucket: ''
          IncludeCookies: false
          Prefix: ''
        Origins:
          - ConnectionAttempts: 3
            ConnectionTimeout: 10
            DomainName: !GetAtt ExampleClientAppBucket.DomainName
            Id: example-client-app
            OriginPath: ''
            OriginShield:
              Enabled: false
            S3OriginConfig:
              OriginAccessIdentity:
                Fn::Sub: 'origin-access-identity/cloudfront/${ExampleCloudFrontOriginAccessIdentity}'
        PriceClass: PriceClass_All
        ViewerCertificate:
          AcmCertificateArn: !Sub "arn:aws:acm:us-east-1:${AwsAccountId}:certificate/${AcmCertificateId}"
          SslSupportMethod: sni-only
        WebACLId: ''

  # ... which depends on having a bucket for staging, a URL, and a Policy
  ExampleAppClientURL:
    Type: 'AWS::Route53::RecordSetGroup'
    Properties:
      HostedZoneId: !Ref RootHostedZone
      RecordSets:
        - Name:  !Sub "${AppDomain}.${RootDomain}"
          Type: A
          AliasTarget:
            HostedZoneId: !Ref CfHostedZone
            DNSName: !GetAtt
              - ExampleAppDistribution
              - DomainName

  ExampleClientAppBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AppDomain}.${RootDomain}"

  ExampleClientAppBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ExampleClientAppBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: 's3:GetObject'
            Resource:
              - !Sub "arn:aws:s3:::${ExampleClientAppBucket}/*"
            Principal:
              AWS: !Sub "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity ${ExampleCloudFrontOriginAccessIdentity}"

  ExampleCloudFrontOriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: 'Serverless website OA'







