AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  A Serverless Application

Parameters:
  RootDomain:
    Type: String
    Default: "thebadsoftwareclub.net"

  AwsAccountId:
    Type: String
    Default: "822675929081"

  AcmCertificateId:
    Type: String
    Default: "16199f7e-0c14-47a7-b348-2e294738b3ba"

  RootHostedZone:
    Type: String
    Default: "Z0608589Z32H3ZBSW3HW"

  MtnFuzzAppDomain:
    Type: String
    Default: "mtnfuzz"

  MtnFuzzAuthDomain:
    Type: String
    Default: "mtnfuzzauth"

  MtnFuzzApiDomain:
    Type: String
    Default: "mtnfuzzapi"

  CfHostedZone:
    Type: String
    Default: "Z2FDTNDATAQYW2"




Resources:

  # The Cognito User Pool, Client, and Domain are for the Authentication Service
  MtnFuzzUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: mtnfuzzusers
      AutoVerifiedAttributes:
        - email
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
          RequireUppercase: true
      UsernameAttributes:
        - email
      Schema:
        - AttributeDataType: String
          Name: email
          Required: false

  MtnFuzzUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref MtnFuzzUserPool
      ClientName: MtnFuzzUserPoolClient
      GenerateSecret: false
      AllowedOAuthFlows:
        - implicit
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthScopes:
        - openid
        - email
        - profile
      CallbackURLs:
        - !Sub "https://${MtnFuzzAppDomain}.${RootDomain}"
      ExplicitAuthFlows:
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_USER_SRP_AUTH
        - ALLOW_CUSTOM_AUTH
      SupportedIdentityProviders:
        - COGNITO

  MtnFuzzUserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      UserPoolId: !Ref MtnFuzzUserPool
      Domain: !Sub "${MtnFuzzAuthDomain}.${RootDomain}"
      CustomDomainConfig:
        CertificateArn: !Sub "arn:aws:acm:us-east-1:${AwsAccountId}:certificate/${AcmCertificateId}"

        #   ... creating the record set for the cognito auth url is still pending an  outstanding issue and requires a
        #  workaround not included in this example: https://github.com/aws-cloudformation/cloudformation-coverage-roadmap/issues/241

  # The Data Bucket is in S3 for Object Storage
  MtnFuzzDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: mtnfuzz-data-store

  # DynamoDB Tables are for key-value data
  MtnFuzzPlansTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: mtnfuzzplans
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: createdBy
          AttributeType: S
        - AttributeName: planId
          AttributeType: S
      KeySchema:
        - AttributeName: planId
          KeyType: HASH
        - AttributeName: createdBy
          KeyType: RANGE

  MtnFuzzRunsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: mtnfuzzruns
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: planId
          AttributeType: S
        - AttributeName: runId
          AttributeType: S
      KeySchema:
        - AttributeName: planId
          KeyType: HASH
        - AttributeName: runId
          KeyType: RANGE

  # The Api and Lambda Functions make up the server-side functionality
  MtnFuzzApi:
    Type: AWS::Serverless::Api
    Properties:
      Domain:
        DomainName: !Sub "${MtnFuzzApiDomain}.${RootDomain}"
        CertificateArn: !Sub "arn:aws:acm:us-east-1:${AwsAccountId}:certificate/${AcmCertificateId}"
        EndpointConfiguration: EDGE
        Route53:
          HostedZoneId: !Ref RootHostedZone

      Auth:
        Authorizers:
          MtnFuzzAuth:
            AuthorizationScopes:
              - email
              - openid
            UserPoolArn: !GetAtt MtnFuzzUserPool.Arn
            Identity:
              Header: Authorization
      StageName: Prod
      DefinitionBody:
        openapi: "3.0.1"
        info:
          title: "MtnFuzzApi"
          version: "1.0"
        servers:
          - url:  !Sub "https://${MtnFuzzApiDomain}.${RootDomain}"
        paths:
          /:
            get:
              parameters:
                - name: "Access-Control-Allow-Origin"
                  in: "header"
                  schema:
                    type: "string"
              responses:
                "404":
                  description: "404 response"
                  content: { }
                "500":
                  description: "500 response"
                  content: { }
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                    Access-Control-Allow-Methods:
                      schema:
                        type: "string"
                    Access-Control-Allow-Credentials:
                      schema:
                        type: "string"
                    Access-Control-Allow-Headers:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - exampleAuth: [ ]
              x-amazon-apigateway-integration:
                responses:
                  "5\\d{2}":
                    statusCode: "500"
                  "2\\d{2}":
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                    responseTemplates:
                      application/json: "{\r\n    \"statusCode\": 200,\r\n    \"message\"\
                                    : \"API Response\"\r\n}"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_templates"
                type: "mock"
            options:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                    Access-Control-Allow-Methods:
                      schema:
                        type: "string"
                    Access-Control-Allow-Credentials:
                      schema:
                        type: "string"
                    Access-Control-Allow-Headers:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"
          /plans:
            get:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - MtnFuzzAuth: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:822675929081:function:MtnFuzzPlansFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            post:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - MtnFuzzAuth: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:822675929081:function:MtnFuzzPlansFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                    Access-Control-Allow-Methods:
                      schema:
                        type: "string"
                    Access-Control-Allow-Headers:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS,POST'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                    responseTemplates:
                      application/json: "{}\n"
                requestTemplates:
                  application/json: "{\n  \"statusCode\" : 200\n}\n"
                passthroughBehavior: "when_no_match"
                type: "mock"
          /plans/createdBy:
            get:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - MtnFuzzAuth: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:822675929081:function:MtnFuzzPlansFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                    Access-Control-Allow-Methods:
                      schema:
                        type: "string"
                    Access-Control-Allow-Headers:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"
          /plans/{planId+}:
            get:
              parameters:
                - name: "planId"
                  in: "path"
                  required: true
                  schema:
                    type: "string"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - exampleAuth: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:822675929081:function:MtnFuzzPlansFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                cacheNamespace: "15yjo6"
                cacheKeyParameters:
                  - "method.request.path.planId"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            put:
              parameters:
                - name: "planId"
                  in: "path"
                  required: true
                  schema:
                    type: "string"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - exampleAuth: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:822675929081:function:MtnFuzzPlansFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                cacheNamespace: "15yjo6"
                cacheKeyParameters:
                  - "method.request.path.planId"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            delete:
              parameters:
                - name: "planId"
                  in: "path"
                  required: true
                  schema:
                    type: "string"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - MtnFuzzAuth: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:822675929081:function:MtnFuzzPlansFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                cacheNamespace: "15yjo6"
                cacheKeyParameters:
                  - "method.request.path.planId"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              parameters:
                - name: "planId"
                  in: "path"
                  required: true
                  schema:
                    type: "string"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                    Access-Control-Allow-Methods:
                      schema:
                        type: "string"
                    Access-Control-Allow-Headers:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'DELETE,GET,HEAD,OPTIONS,PATCH,POST,PUT'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"
          /runs:
            get:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - MtnFuzzAuth: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:822675929081:function:MtnFuzzRunsFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            post:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - MtnFuzzAuth: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:822675929081:function:MtnFuzzRunsFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                    Access-Control-Allow-Methods:
                      schema:
                        type: "string"
                    Access-Control-Allow-Headers:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS,POST'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"
          /runs/planId/{planId}:
            post:
              parameters:
                - name: "planId"
                  in: "path"
                  required: true
                  schema:
                    type: "string"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              security:
                - MtnFuzzAuth: [ ]
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:822675929081:function:MtnFuzzRunsFn/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                    Access-Control-Allow-Methods:
                      schema:
                        type: "string"
                    Access-Control-Allow-Headers:
                      schema:
                        type: "string"
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/Empty"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'OPTIONS,POST'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"

  MtnFuzzPlansFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: MtnFuzzPlansFn
      Role: !GetAtt MtnFuzzPlansRole.Arn
      Handler: lambda_function.lambda_handler
      Runtime: python3.7
      CodeUri: functions/plans/
      Description: >-
        plans
      MemorySize: 512
      Timeout: 10
      Layers:
        - arn:aws:lambda:us-west-2:822675929081:layer:dependencies:3
      Events:
        PlansCreatedByEvent:
          Type: Api
          Properties:
            Path: '/plans/createdBy'
            Method: get
            RestApiId:
              Ref: MtnFuzzApi
        NewPlanEvent:
          Type: Api
          Properties:
            Path: '/plans'
            Method: post
            RestApiId:
              Ref: MtnFuzzApi
        GetPlanEvent:
          Type: Api
          Properties:
            Path: '/plans/{planId+}'
            Method: get
            RestApiId:
              Ref: MtnFuzzApi
        UpdatePlanEvent:
          Type: Api
          Properties:
            Path: '/plans/{planId+}'
            Method: put
            RestApiId:
              Ref: MtnFuzzApi
        DeletePlanEvent:
          Type: Api
          Properties:
            Path: '/plans/{planId+}'
            Method: delete
            RestApiId:
              Ref: MtnFuzzApi

  MtnFuzzRunsFn:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: MtnFuzzRunsFn
      Role: !GetAtt MtnFuzzPlansRole.Arn
      Handler: lambda_function.lambda_handler
      Runtime: python3.7
      CodeUri: functions/runs/
      Description: >-
        runs
      MemorySize: 512
      Timeout: 10
      Layers:
        - arn:aws:lambda:us-west-2:822675929081:layer:dependencies:3
      Events:
        NewRunEvent:
          Type: Api
          Properties:
            Path: '/runs'
            Method: post
            RestApiId:
              Ref: MtnFuzzApi
        GetRunsEvent:
          Type: Api
          Properties:
            Path: '/runs'
            Method: get
            RestApiId:
              Ref: MtnFuzzApi
        DeleteRunEvent:
          Type: Api
          Properties:
            Path: '/runs'
            Method: delete
            RestApiId:
              Ref: MtnFuzzApi

  # ... with a log-group for server-side logs
  MtnFuzzPlansLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${MtnFuzzPlansFn}"
      RetentionInDays: 30

  MtnFuzzRunsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${MtnFuzzRunsFn}"
      RetentionInDays: 30

  # ... and permissions for the Lambdas
  MtnFuzzPlansRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole

  MtnFuzzLogGroupPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "allow-lambda-logging"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - logs:CreateLogStream
              - logs:DescribeLogStreams
              - logs:PutLogEvents
            Resource:
              - "arn:aws:logs:*:822675929081:log-group:/aws/lambda/MtnFuzzPlansFn"
              - "arn:aws:logs:*:822675929081:log-group:/aws/lambda/MtnFuzzPlansFn:log-stream:*"
              - "arn:aws:logs:*:822675929081:log-group:/aws/lambda/MtnFuzzRunsFn"
              - "arn:aws:logs:*:822675929081:log-group:/aws/lambda/MtnFuzzRunsFn:log-stream:*"
      Roles:
        - !Ref MtnFuzzPlansRole

  MtnFuzzDynamoDBPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "allow-dynamoDB-access"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:BatchGetItem
              - dynamodb:BatchWriteItem
              - dynamodb:ConditionCheckItem
              - dynamodb:PutItem
              - dynamodb:DeleteItem
              - dynamodb:DescribeContributorInsights
              - dynamodb:Scan
              - dynamodb:ListTagsOfResource
              - dynamodb:Query
              - dynamodb:DescribeStream
              - dynamodb:UpdateItem
              - dynamodb:DescribeTimeToLive
              - dynamodb:PartiQLSelect
              - dynamodb:DescribeTable
              - dynamodb:GetShardIterator
              - dynamodb:GetItem
              - dynamodb:DescribeContinuousBackups
              - dynamodb:DescribeKinesisStreamingDestination
              - dynamodb:GetRecords
              - dynamodb:DescribeTableReplicaAutoScaling
            Resource:
              - "arn:aws:dynamodb:us-west-2:822675929081:table/plans"
              - "arn:aws:dynamodb:*:822675929081:table/plans/stream/*"
              - "arn:aws:dynamodb:us-west-2:822675929081:table/runs"
              - "arn:aws:dynamodb:*:822675929081:table/runs/stream/*"
      Roles:
        - !Ref MtnFuzzPlansRole

  MtnFuzzS3DataStorePolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "allow-datastore-access"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - s3:PutObject
              - s3:GetObject
              - s3:ListBucket
              - s3:DeleteObject
            Resource:
              - "arn:aws:s3:::mtnfuzz-data-store/*"
              - "arn:aws:s3:::mtnfuzz-data-store"
      Roles:
        - !Ref MtnFuzzPlansRole

  # The Client-side app is hosted with a CloudFront Distribution.
  MtnFuzzAppDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Comment: 'Cloudfront distribution for client App'
        Aliases:
          - !Sub "${MtnFuzzAppDomain}.${RootDomain}"
        DefaultCacheBehavior:
          AllowedMethods:
            - HEAD
            - GET
            - OPTIONS
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
          Compress: true
          SmoothStreaming: false
          TargetOriginId: mtnfuzz-client-app
          ViewerProtocolPolicy: redirect-to-https
        DefaultRootObject: index.html
        Enabled: true
        HttpVersion: http2
        Logging:
          Bucket: ''
          IncludeCookies: false
          Prefix: ''
        Origins:
          - ConnectionAttempts: 3
            ConnectionTimeout: 10
            DomainName: !GetAtt MtnFuzzClientAppBucket.DomainName
            Id: mtnfuzz-client-app
            OriginPath: ''
            OriginShield:
              Enabled: false
            S3OriginConfig:
              OriginAccessIdentity:
                Fn::Sub: 'origin-access-identity/cloudfront/${MtnFuzzCloudFrontOriginAccessIdentity}'
        PriceClass: PriceClass_All
        ViewerCertificate:
          AcmCertificateArn: !Sub "arn:aws:acm:us-east-1:${AwsAccountId}:certificate/${AcmCertificateId}"
          SslSupportMethod: sni-only
        WebACLId: ''

  # ... which depends on having a bucket for staging, a URL, and a Policy
  MtnFuzzAppClientURL:
    Type: 'AWS::Route53::RecordSetGroup'
    Properties:
      HostedZoneId: !Ref RootHostedZone
      RecordSets:
        - Name:  !Sub "${MtnFuzzAppDomain}.${RootDomain}"
          Type: A
          AliasTarget:
            HostedZoneId: !Ref CfHostedZone
            DNSName: !GetAtt
              - MtnFuzzAppDistribution
              - DomainName

  MtnFuzzClientAppBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref MtnFuzzAppDomain

  MtnFuzzClientAppBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref MtnFuzzClientAppBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: 's3:GetObject'
            Resource:
              - !Sub "arn:aws:s3:::${MtnFuzzClientAppBucket}/*"
            Principal:
              AWS: !Sub "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity ${MtnFuzzCloudFrontOriginAccessIdentity}"

  MtnFuzzCloudFrontOriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: 'Serverless website OA'







